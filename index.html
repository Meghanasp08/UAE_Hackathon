<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Credit - Dashboard</title>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="css/carbon-reduction.css"/>
  <script>
    // Redirect to login if not authenticated
    (function() {
      const token = localStorage.getItem('authToken');
      const loginTime = localStorage.getItem('loginTime');
      
      if (!token || !loginTime) {
        window.location.href = 'login.html';
        return;
      }
      
      // Check session expiry (24 hours)
      const sessionDuration = 24 * 60 * 60 * 1000;
      const elapsed = Date.now() - parseInt(loginTime);
      
      if (elapsed > sessionDuration) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        localStorage.removeItem('loginTime');
        window.location.href = 'login.html';
      }
    })();
  </script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="assets/shukria-logo.png" alt="Shukria Logo" class="logo" onerror="this.style.display='none'"/>
    </div>
    <nav class="nav-links">
      <a href="index.html" class="nav-link active" title="Dashboard" aria-label="Dashboard">
        <div class="nav-item">
          <img src="assets/nav-dashboard.svg" alt="Dashboard" style="height:28px;width:28px;"/>
          <span class="nav-label">Dashboard</span>
        </div>
      </a>
      <a href="credit-line.php" class="nav-link" title="Credit Line" aria-label="Credit Line">
        <div class="nav-item">
          <img src="assets/nav-credit-line.svg" alt="Credit Line" style="height:28px;width:28px;"/>
          <span class="nav-label">Credit Line</span>
        </div>
      </a>
      <a href="apply.php" class="nav-link" title="Apply" aria-label="Apply">
        <div class="nav-item">
          <img src="assets/nav-apply.svg" alt="Apply" style="height:28px;width:28px;"/>
          <span class="nav-label">Apply</span>
        </div>
      </a>
      <a href="accounts.php" class="nav-link" title="Accounts" aria-label="Accounts">
        <div class="nav-item">
          <img src="assets/nav-transactions.svg" alt="Accounts" style="height:28px;width:28px;"/>
          <span class="nav-label">Accounts</span>
        </div>
      </a>
      <a href="transactions.html" class="nav-link" title="Transactions" aria-label="Transactions">
        <div class="nav-item">
          <img src="assets/nav-transactions.svg" alt="Transactions" style="height:28px;width:28px;"/>
          <span class="nav-label">Transactions</span>
        </div>
      </a>
    </nav>
    <div class="user-section">
      <div class="user">Hello, Priya Sharma</div>
      <button class="logout-btn" id="logoutBtn" onclick="if(typeof logout === 'function') logout();" title="Logout">âžœ]</button>
    </div>
  </header>

  <main class="container">
    <section class="welcome">
      <h2>Your Financial Dashboard</h2>
    </section>

    <section class="cards">
      <article class="card" role="region" aria-label="Available Credit">
        <div class="card-icon">ðŸ’³</div>
        <h3>Available Credit</h3>
        <p class="large" id="availableCredit">AED 12,500</p>
        <span class="card-meta">of AED 15,250 limit</span>
      </article>
      <article class="card" role="region" aria-label="Used Credit">
        <div class="card-icon">ðŸ“Š</div>
        <h3>Used</h3>
        
        <p class="large" id="usedCredit">AED 2,750</p>
        <span class="card-meta">18% utilization</span>
      </article>
      <article class="card" role="region" aria-label="Loan Eligibility">
        <div class="card-icon">ðŸ’°</div>
        <h3>Loan Eligible</h3>
        <p class="large" id="loanEligible">AED 1,000,000</p>
  <span class="card-meta">Eligible for up to AED 1,000,000</span>
      </article>
      <article class="card" role="region" aria-label="Credit Score">
        <div class="card-icon">ðŸ“Š</div>
        <h3>Credit Score</h3>
        <p class="large" id="creditScore">88 / 100</p>
        <span class="card-meta">Excellent standing</span>
      </article>
    </section>

    <section class="controls">
      <button id="applyBtn" class="btn-primary" onclick="location.href='apply.html'">
        Apply for Smart Credit
      </button>
      <button id="openCredit" class="btn-outline" onclick="location.href='credit-line.html'">
        Open Credit Controls
      </button>
      <button id="viewLoanOffers" class="btn-primary" onclick="location.href='loan-offers.html'">
        View Loan Offers (3)
      </button>
    </section>

    <section class="recent">
      <h2>Recent Activity</h2>
      <ul id="recentList" class="list" role="list">
        <li class="list-item" role="listitem">
          <div class="list-content">
            <span class="merchant">Fuel Station - ENOC</span>
            <span class="amount">-AED 120</span>
          </div>
          <span class="date">Nov 5, 2025</span>
        </li>
        <li class="list-item" role="listitem">
          <div class="list-content">
            <span class="merchant">Supermarket - Carrefour</span>
            <span class="amount">-AED 230</span>
          </div>
          <span class="date">Nov 4, 2025</span>
        </li>
        <li class="list-item green" role="listitem">
          <div class="list-content">
            <span class="merchant">EV Charger ðŸŒ±</span>
            <span class="amount">-AED 45</span>
          </div>
          <span class="date">Nov 3, 2025 Â· Low carbon</span>
        </li>
      </ul>
      <button class="btn-text" onclick="location.href='transactions.html'">View All Transactions â†’</button>
    </section>

    <!-- Carbon Reduction Widget -->
    <div class="carbon-reduction-widget" id="carbonWidget">
      <h3>ðŸŒ± Carbon Reduction Progress</h3>
      <div class="carbon-stats-grid">
        <div class="carbon-stat">
          <span class="carbon-stat-label">This Month</span>
          <span class="carbon-stat-value">245<span class="carbon-stat-unit">kg COâ‚‚e</span></span>
        </div>
        <div class="carbon-stat">
          <span class="carbon-stat-label">Saved</span>
          <span class="carbon-stat-value">35<span class="carbon-stat-unit">kg</span></span>
        </div>
        <div class="carbon-stat">
          <span class="carbon-stat-label">Points Earned</span>
          <span class="carbon-stat-value" id="dashboardPoints">53</span>
        </div>
        <div class="carbon-stat">
          <span class="carbon-stat-label">Your Tier</span>
          <span class="tier-badge silver" id="dashboardTier">
            <span>ðŸ¥ˆ</span> Silver
          </span>
        </div>
      </div>
      <div class="tier-progress">
        <div class="tier-progress-label">
          <span>Progress to Gold</span>
          <span id="pointsToNext">15 points to go</span>
        </div>
        <div class="tier-progress-bar">
          <div class="tier-progress-fill" id="tierProgressFill" style="width: 67.5%"></div>
        </div>
      </div>
      <div class="reduction-comparison">
        <div class="comparison-text">
          <span class="comparison-arrow down">â†“</span>
          <span>12.5% reduction vs last month</span>
        </div>
      </div>
    </div>
  </main>

  <!-- Voice feedback live region -->
  <div id="voiceFeedback" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal for quick actions -->
  <div id="actionModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Quick Action</h3>
        <button class="modal-close" aria-label="Close modal">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <script src="js/term-loan.js"></script>
  <script src="js/carbon-points.js"></script>
  <script src="js/main.js"></script>
  <script>
    // Load carbon data on dashboard
    document.addEventListener('DOMContentLoaded', async () => {
      if (typeof mockAPI !== 'undefined' && mockAPI.getESGData) {
        try {
          const esgData = await mockAPI.getESGData('account_123');
          
          // Update carbon widget
          const pointsEl = document.getElementById('dashboardPoints');
          const tierEl = document.getElementById('dashboardTier');
          const pointsToNextEl = document.getElementById('pointsToNext');
          const progressFillEl = document.getElementById('tierProgressFill');
          
          if (pointsEl) pointsEl.textContent = esgData.reductionPoints;
          
          if (tierEl && esgData.tier) {
            const tierClass = esgData.tier.name.toLowerCase();
            tierEl.className = `tier-badge ${tierClass}`;
            tierEl.innerHTML = `<span>${esgData.tier.icon}</span> ${esgData.tier.name}`;
          }
          
          if (pointsToNextEl && esgData.tier) {
            if (esgData.tier.pointsToNext > 0) {
              pointsToNextEl.textContent = `${esgData.tier.pointsToNext} points to go`;
            } else {
              pointsToNextEl.textContent = 'Max tier achieved!';
            }
          }
          
          if (progressFillEl && esgData.tier) {
            progressFillEl.style.width = `${esgData.tier.progress}%`;
          }
          
        } catch (error) {
          console.error('Error loading carbon data:', error);
        }
      }
    });

    // Accordion functionality
    function toggleAccordion(section) {
      const accordion = document.getElementById(section + 'Accordion');
      const header = document.getElementById(section + 'Header');
      const arrow = document.getElementById(section + 'Arrow');
      
      if (accordion.classList.contains('active')) {
        // Close accordion
        accordion.classList.remove('active');
        header.classList.remove('active');
        arrow.style.transform = 'rotate(0deg)';
      } else {
        // Open accordion and load content
        accordion.classList.add('active');
        header.classList.add('active');
        arrow.style.transform = 'rotate(90deg)';
        
        // Load content based on section
        if (section === 'termLoans') {
          loadTermLoansDashboard();
        } else if (section === 'bnpl') {
          loadBNPLPlans();
        }
      }
    }

    // Update counts in accordion headers
    function updateAccordionCounts() {
      // Update term loans count
      if (typeof TermLoanManager !== 'undefined') {
        const activeLoans = TermLoanManager.getActiveTermLoans();
        const termLoansCount = document.getElementById('termLoansCount');
        if (termLoansCount) {
          termLoansCount.textContent = `(${activeLoans.length})`;
        }
      }
      
      // Update BNPL count
      const activeBnplPlans = mockBNPLPlans ? mockBNPLPlans.filter(plan => plan.status === 'active') : [];
      const bnplCount = document.getElementById('bnplCount');
      if (bnplCount) {
        bnplCount.textContent = `(${activeBnplPlans.length})`;
      }
    }

    // Dashboard initialization
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication before loading page
      if (typeof requireAuth === 'function') {
        requireAuth();
      }
      
      // Update user display
      if (typeof updateUserDisplay === 'function') {
        updateUserDisplay();
      }
      
      // Wait for TermLoanManager to be available
      setTimeout(() => {
        if (typeof TermLoanManager !== 'undefined') {
          // Ensure sample loans exist
          TermLoanManager.createSampleLoans();
          // Update counts
          updateAccordionCounts();
          // Show the finance products section
          const financeSection = document.querySelector('.finance-products-section');
          if (financeSection) {
            financeSection.style.display = 'block';
          }
        }
      }, 600);
    });

    // Mock BNPL data for dashboard
    const mockBNPLPlans = [
      {
        id: 'bnpl_1',
        merchant: 'Apple Store',
        totalAmount: 2999,
        remainingAmount: 1499.50,
        installments: 4,
        paidInstallments: 2,
        nextPayment: '2025-12-01',
        monthlyAmount: 749.75,
        status: 'active'
      },
      {
        id: 'bnpl_2',
        merchant: 'IKEA',
        totalAmount: 1200,
        remainingAmount: 400,
        installments: 3,
        paidInstallments: 2,
        nextPayment: '2025-11-25',
        monthlyAmount: 400,
        status: 'active'
      }
    ];

    function loadTermLoansDashboard() {
      // Check if TermLoanManager is available
      if (typeof TermLoanManager === 'undefined') {
        console.log('TermLoanManager not available yet');
        return;
      }

      const termLoansList = document.getElementById('termLoansList');
      const noLoansMessage = document.getElementById('noTermLoans');
      
      const activeLoans = TermLoanManager.getActiveTermLoans();
      console.log('Active loans found:', activeLoans.length);
      
      if (activeLoans.length > 0) {
        // Show term loans list, hide no loans message
        if (termLoansList) termLoansList.style.display = 'grid';
        if (noLoansMessage) noLoansMessage.style.display = 'none';
        
        // Populate loans list
        termLoansList.innerHTML = activeLoans.map(loan => `
          <div class="term-loan-card">
            <div class="loan-header">
              <h4>Term Loan ${loan.id.substring(0, 10)}...</h4>
              <span class="loan-status ${loan.status}">${loan.status.toUpperCase()}</span>
            </div>
            <div class="loan-details">
              <div class="loan-row">
                <span>Original Amount:</span>
                <span>AED ${loan.loanAmount.toLocaleString()}</span>
              </div>
              <div class="loan-row">
                <span>Remaining Balance:</span>
                <span class="highlight">AED ${loan.remainingBalance.toLocaleString()}</span>
              </div>
              <div class="loan-row">
                <span>Monthly Payment:</span>
                <span>AED ${loan.emi.toLocaleString()}</span>
              </div>
              <div class="loan-row">
                <span>Next Payment:</span>
                <span>${new Date(loan.nextDueDate).toLocaleDateString()}</span>
              </div>
              <div class="loan-row">
                <span>Remaining Terms:</span>
                <span>${loan.remainingTerms} months</span>
              </div>
            </div>
            <div class="loan-actions">
              <button class="btn-outline small" onclick="makePayment('${loan.id}')">Make Payment</button>
              <button class="btn-text small" onclick="viewLoanDetails('${loan.id}')">View Details</button>
            </div>
          </div>
        `).join('');
        
      } else {
        // Show no loans message
        console.log('No active loans found');
        if (termLoansList) {
          termLoansList.style.display = 'none';
          termLoansList.innerHTML = '';
        }
        if (noLoansMessage) noLoansMessage.style.display = 'block';
      }
      
      // Update count
      updateAccordionCounts();
    }

    function loadBNPLPlans() {
      const bnplPlansList = document.getElementById('bnplPlansList');
      const noBnplPlans = document.getElementById('noBnplPlans');
      
      if (!bnplPlansList || !noBnplPlans) return;
      
      const activePlans = mockBNPLPlans.filter(plan => plan.status === 'active');
      
      if (activePlans.length > 0) {
        bnplPlansList.style.display = 'grid';
        noBnplPlans.style.display = 'none';
        
        bnplPlansList.innerHTML = activePlans.map(plan => {
          const progress = (plan.paidInstallments / plan.installments) * 100;
          
          return `
            <div class="bnpl-plan-card">
              <div class="bnpl-header">
                <h4>${plan.merchant}</h4>
                <span class="bnpl-status ${plan.status}">${plan.status.toUpperCase()}</span>
              </div>
              
              <div class="bnpl-details">
                <div class="bnpl-row">
                  <span>Total Amount:</span>
                  <span>AED ${plan.totalAmount.toLocaleString()}</span>
                </div>
                <div class="bnpl-row">
                  <span>Remaining:</span>
                  <span class="highlight">AED ${plan.remainingAmount.toLocaleString()}</span>
                </div>
                <div class="bnpl-row">
                  <span>Monthly Payment:</span>
                  <span>AED ${plan.monthlyAmount.toLocaleString()}</span>
                </div>
                <div class="bnpl-row">
                  <span>Next Payment:</span>
                  <span>${plan.nextPayment}</span>
                </div>
                <div class="bnpl-row">
                  <span>Progress:</span>
                  <span>${plan.paidInstallments}/${plan.installments} installments</span>
                </div>
              </div>
              
              <div class="bnpl-progress">
                <div class="bnpl-progress-bar">
                  <div class="bnpl-progress-fill" style="width: ${progress}%"></div>
                </div>
              </div>
              
              <div class="bnpl-actions">
                <button class="btn-outline small" onclick="viewBNPLDetails('${plan.id}')">
                  View Details
                </button>
                <button class="btn-primary small" onclick="payBNPLInstallment('${plan.id}')">
                  Pay Now
                </button>
              </div>
            </div>
          `;
        }).join('');
        
      } else {
        bnplPlansList.style.display = 'none';
        noBnplPlans.style.display = 'block';
      }
      
      // Update count
      updateAccordionCounts();
    }

    function makePayment(loanId) {
      const loan = TermLoanManager.getTermLoanById(loanId);
      if (!loan) return;
      
      const amount = prompt(`Enter payment amount for loan ${loanId}:\nMonthly EMI: AED ${loan.emi}\nRemaining balance: AED ${loan.remainingBalance}`);
      
      if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        try {
          const result = TermLoanManager.makePayment(loanId, parseFloat(amount));
          if (result.success) {
            alert(`Payment of AED ${amount} processed successfully!`);
            loadTermLoansDashboard(); // Refresh the display
          }
        } catch (error) {
          alert(`Error processing payment: ${error.message}`);
        }
      }
    }

    function viewLoanDetails(loanId) {
      const loan = TermLoanManager.getTermLoanById(loanId);
      if (!loan) return;
      
      const details = `
Term Loan Details:

Loan ID: ${loan.id}
Original Amount: AED ${loan.loanAmount.toLocaleString()}
Remaining Balance: AED ${loan.remainingBalance.toLocaleString()}
Monthly Payment: AED ${loan.emi.toLocaleString()}
Interest Rate: ${(loan.annualRate * 100).toFixed(1)}% APR
Term: ${loan.termMonths} months
Remaining Terms: ${loan.remainingTerms} months
Status: ${loan.status}
Created: ${new Date(loan.createdAt).toLocaleDateString()}
Next Payment Due: ${new Date(loan.nextDueDate).toLocaleDateString()}
Payments Made: ${loan.paymentsMade}
Total Paid: AED ${loan.totalPaid.toLocaleString()}
      `;
      
      alert(details);
    }

    // BNPL Functions
    function viewBNPLDetails(planId) {
      const plan = mockBNPLPlans.find(p => p.id === planId);
      if (plan) {
        const details = `
BNPL Plan Details:

Merchant: ${plan.merchant}
Plan ID: ${plan.id}
Total Amount: AED ${plan.totalAmount.toLocaleString()}
Remaining Balance: AED ${plan.remainingAmount.toLocaleString()}
Monthly Payment: AED ${plan.monthlyAmount.toLocaleString()}
Installments: ${plan.paidInstallments}/${plan.installments} completed
Next Payment: ${plan.nextPayment}
Status: ${plan.status}
        `;
        alert(details);
      }
    }

    function payBNPLInstallment(planId) {
      const plan = mockBNPLPlans.find(p => p.id === planId);
      if (plan && plan.remainingAmount > 0) {
        const confirmed = confirm(`Pay AED ${plan.monthlyAmount} for ${plan.merchant} BNPL plan?`);
        if (confirmed) {
          // Simulate payment
          plan.paidInstallments++;
          plan.remainingAmount = Math.max(0, plan.remainingAmount - plan.monthlyAmount);
          
          if (plan.remainingAmount === 0) {
            plan.status = 'completed';
            alert(`BNPL plan for ${plan.merchant} has been completed successfully!`);
          } else {
            alert(`Payment successful! Remaining balance: AED ${plan.remainingAmount}`);
          }
          
          // Reload BNPL plans
          loadBNPLPlans();
        }
      }
    }

    // Make functions globally available
    window.toggleAccordion = toggleAccordion;
    window.viewBNPLDetails = viewBNPLDetails;
    window.payBNPLInstallment = payBNPLInstallment;
  </script>
</body>
</html>
